# vim:tw=0:ts=2:sw=2:et:norl
# Author: Landon Bouma <https://tallybark.com/>
# Project: https://github.com/doblabs/easy-as-pypi#ðŸ¥§
# License: MIT
# yamllint disable rule:line-length

---

name: 'Prepare Poetry assets'

description: 'Setup top-level pyproject.toml and poetry.lock for pre-release vs. normal work'

inputs:
  prerelease:
    description: 'Set true if pre-release context, else leave false for normal'
    type: boolean
    required: true
    default: false

# outputs:
#   nothing:
#     description: "Nothing"
#     value: null

runs:
  using: "composite"
  steps:
    - name: Trace vars
      # While not normally required in job steps,
      # 'shell' is required in action steps.
      shell: bash
      run: |
        echo "inputs.prerelease: ${{ inputs.prerelease }}"
        echo "github.action_path: ${{ github.action_path }}"

    # ALERT: Assumes EAPP-infused repo is checked out.

    # NOICE: DRY: Use `make --eval` to add temp. make target that prints
    # the pre-release pyproject.toml directory (avoids USYNC/hardcoding).
    - name: Determine pyproject.toml to use (normal or alpha)
      shell: bash
      run: |
        pyproject_dir="."

        if [ "${{ inputs.prerelease }}" = "true" ]; then
          pyproject_dir="$(
            make \
              --eval='print-var: ; @echo $(PYPROJECT_PRERELEASE_DIR)' \
              print-var
          )"
        fi

        echo "PYPROJECT_DIR=${pyproject_dir}"

        echo "PYPROJECT_DIR=${pyproject_dir}" >> "${GITHUB_ENV}"

    - name: Verify Poetry assets â€” pyproject.toml and poetry.lock
      shell: bash
      run: |
        assets_exist () {
          local pyproject_dir="${1:-.}"

          [ -f "${pyproject_dir}/pyproject.toml" ] \
          && [ -f "${pyproject_dir}/poetry.lock" ]
        }

        if [ "${{ inputs.prerelease }}" = "true" ]; then
          if ! assets_exist "${PYPROJECT_DIR}"; then
            >&2 echo "ERROR: Where are the ${PYPROJECT_DIR} Poetry assets?"
            >&2 echo "- Missing pyproject.toml and/or poetry.lock"
            >&2 echo "- HINT: Run the update-deps.yml workflow"
            >&2 echo "  - OR: Run \`make prepare-poetry-prerelease\`"
            >&2 echo "        and then commit the two files to the repo"

            exit 1
          fi
        elif ! assets_exist; then
          >&2 echo "ERROR: Missing pyproject.toml and/or poetry.lock"
          >&2 echo "- HINT: Run the update-deps.yml workflow"
          >&2 echo "  - OR: Run \`make install\`"
          >&2 echo "        and then commit the lock file to the repo"

          exit 1
        fi

    # Note that `poetry -C "${PYPROJECT_DIR}" build` won't work if it
    # references anything from root, so clobber root's lock and toml.
    - name: Prepare Pre-release Poetry assets â€” pyproject.toml and poetry.lock
      if: inputs.prerelease
      shell: bash
      run: |
        command cp -f "${PYPROJECT_DIR}/poetry.lock" "poetry.lock"
        command cp -f "${PYPROJECT_DIR}/pyproject.toml" "pyproject.toml"
