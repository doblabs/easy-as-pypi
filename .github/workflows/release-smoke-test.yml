# vim:tw=0:ts=2:sw=2:et:norl
# Author: Landon Bouma <https://tallybark.com/>
# Project: https://github.com/doblabs/easy-as-pypi#ðŸ¥§
# License: MIT

---

# USYNC: This name is used by `gh workflow run`.
# - Search for: 'PyPI Smoke test'
name: PyPI Smoke test

run-name: ðŸŽ’ â€” Smoke test â€” ${{ inputs.VERSION }} ... & Cascade dispatch

on:
  workflow_dispatch:
    inputs:
      INDEX_PIP:
        required: false
        type: string
      INDEX_PIPX:
        required: false
        type: string
      PACKAGE_NAME:
        required: true
        type: string
      VERSION:
        required: true
        type: string
      PRERELEASE:
        required: true
        type: boolean

# ***

env:
  # Lest: "The `python-version` input is not set. The version
  #        of Python currently in `PATH` will be used." and
  #       "Cache paths are empty. Please check the previous
  #        logs and make sure that the python version is specified"
  # TRACK: https://github.com/actions/python-versions/releases
  # USYNC: workflows/ (PYTHON_VERSION), tox.ini (basepython), Makefile (VENV_PYVER).
  # BWARE: Trailing zeroes disappear unless quoted.
  PYTHON_VERSION: "3.11"

jobs:
  pip-smoke-test:
    name: pip Smoke test PyPI release

    runs-on: ubuntu-latest

    env:
      INDEX_PIP: ${{ inputs.INDEX_PIP }}
      PACKAGE_NAME: ${{ inputs.PACKAGE_NAME }}
      VERSION: ${{ inputs.VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # FIXME/2023-10-08 21:32: Reeanbling cache...
          cache: 'pip'

      # ***

      # DUNNO: pip-install sometimes won't find the version
      # (even if a previous workflow or job ran the exact
      # same pip-install command and found success, bizarre).
      # - So we'll retry a few times until universe settles.

      # REFER: https://github.com/nick-fields/retry
      - name: Install package
        uses: nick-fields/retry@v2
        with:
          retry_on: error
          max_attempts: 5
          retry_wait_seconds: 5
          # Timeout shouldn't matter, but it's required.
          #  timeout_minutes: 10
          timeout_seconds: 60
          command: |
            echo "pip install $INDEX_PIP $PACKAGE_NAME==$VERSION"
            pip install $INDEX_PIP $PACKAGE_NAME==$VERSION

      - name: Infer module name
        run: echo "MODULE_NAME=${PACKAGE_NAME//-/_}" >> "$GITHUB_ENV"
        shell: bash

      - name: Load it!
        run: |
          python -c "import $MODULE_NAME; print($MODULE_NAME.__version__)"
        shell: bash

  # ***

  # pipx won't install lib-only package, e.g., one without entry point defined.
  #
  # - Otherwise pipx complains:
  #
  #     No apps associated with package easy-as-pypi-appdirs or its dependencies. If
  #     you are attempting to install a library, pipx should not be used. Consider
  #     using pip or a similar tool instead.
  #
  # So do a crude toml grep to see if the Poetry entry point is defined.

  check-is-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Tag
        id: check-is-app
        run: |
          if grep -q -E "^\[tool.poetry.scripts]$" "pyproject.toml"; then
            echo "is_app=true" >> $GITHUB_OUTPUT
          fi

      - name: Report Maybe
        if: steps.check-is-app.outputs.is_app == 'true'
        run: echo "Installs-app detected"

    outputs:
      is_app: ${{ steps.check-is-app.outputs.is_app }}

  # ***

  pipx-smoke-test:
    name: pipx Smoke test PyPI release

    runs-on: ubuntu-latest

    needs: check-is-app
    if: needs.check-is-app.outputs.is_app == 'true'

    env:
      INDEX_PIPX: ${{ inputs.INDEX_PIPX }}
      PACKAGE_NAME: ${{ inputs.PACKAGE_NAME }}
      VERSION: ${{ inputs.VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # FIXME/2023-10-08 21:32: Reeanbling cache...
          cache: 'pip'

      # ***

      # See comment above: The first one or few pipx-install don't
      # always find the version.
      # - 2023-10-08: So far I've only ever seen one retry needed,
      #   and that included a time when pip-install ran immediately,
      #   then pipx-install had to be run twice.

      - name: Install package
        uses: nick-fields/retry@v2
        with:
          retry_on: error
          max_attempts: 5
          retry_wait_seconds: 5
          timeout_seconds: 60
          command: |
            echo "pipx install $INDEX_PIPX $PACKAGE_NAME==$VERSION"
            pipx install $INDEX_PIPX $PACKAGE_NAME==$VERSION

      # Note the poetry-dynamic-versioning works with non-SemVer versions
      # but will make them SemVer-compliant, e.g., it'll change the alpha
      # tag "v1.1.0a3" (non-Semver) to "1.1.0-a.3" (which is SemVer-okay).
      # - On GH and PyPI it's still the original tag, because the
      #   workflow uses the Git tag.
      #   - E.g., given previous example,
      #       pipx install easy-as-pypi==1.1.0a3
      #     works, but `easy-as-pypi version` says:
      #       easy-as-pypi version 1.1.0-a.3
      # - FTREQ/2023-06-04: Validate version in `release-github.yml`:
      #   - Run `poetry dynamic-versioning`.
      #   - Parse Toml to confirm version.
      #   - Cleanup with `git reset --hard HEAD`.
      #   - UCASE: Prevent getting here and failing because PyPI version
      #            and application version are different.
      - name: Run it!
        run: |
          echo "Checking \$PACKAGE_NAME version Â» $VERSION"
          # FIXME/2023-10-01 14:00: This echo probably unnecessary.
          echo "\$ $PACKAGE_NAME version"
          $PACKAGE_NAME version
        shell: bash

      - name: Check version
        run: |
          [ "$($PACKAGE_NAME version)" = "$PACKAGE_NAME version $VERSION" ] \
            || exit 1
        shell: bash

  # ***

  update-cascade:
    name: Run update & release cascade

    uses: ./.github/workflows/update-cascade.yml
    secrets: inherit

    needs: [pip-smoke-test, pipx-smoke-test]

    # Note the 'if' is skipped if any needs were skipped, unless always.
    if: ${{ ! cancelled()
      && needs.pip-smoke-test.result == 'success'
      && (needs.pipx-smoke-test.result == 'success'
          || needs.pipx-smoke-test.result == 'skipped'
      ) }}

    with:
      prerelease: ${{ inputs.PRERELEASE }}
